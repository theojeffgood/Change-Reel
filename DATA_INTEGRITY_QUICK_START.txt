â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘               DATA INTEGRITY ISSUE: INVALID SHAs IN DATABASE                 â•‘
â•‘                         QUICK START GUIDE                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PROBLEM:
  âŒ SHAs stored in database don't exist in GitHub repository
  âŒ fetch_diff jobs failing: "No common ancestor"
  âŒ This cascades to generate_summary failures
  âŒ Data integrity compromised

INVALID SHAs:
  â€¢ Base:  c5c9ea85c587a25046f815cda8434e8fa00b536f
  â€¢ Head:  401951fd91a3e8d32dcaa63333133411c4dd7978

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 1: FIND WHERE INVALID DATA IS (5 minutes)

Run this SQL to find all invalid SHAs:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SELECT 
  id, sha, author, created_at,
  LENGTH(sha) as sha_length,
  CASE 
    WHEN sha ~ '[^a-f0-9]' THEN 'INVALID_CHARS'
    WHEN LENGTH(sha) NOT IN (7, 40) THEN 'WRONG_LENGTH'
    WHEN sha IS NULL THEN 'NULL'
    WHEN sha = '' THEN 'EMPTY'
    ELSE 'OK'
  END as validation
FROM commits
WHERE LENGTH(sha) != 40 AND LENGTH(sha) != 7
   OR sha IS NULL
   OR sha = ''
   OR sha ~ '[^a-f0-9]'
LIMIT 50;
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ“Š Results to look for:
  â€¢ How many invalid SHAs? (If > 10, serious problem)
  â€¢ What's the pattern? (truncated? special chars?)
  â€¢ When were they created? (recent? or old?)
  â€¢ How many projects affected?

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 2: FIND THE SOURCE (5 minutes)

Run this to trace back to where invalid data originated:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SELECT 
  j.id,
  j.type,
  j.status,
  j.error_message,
  j.created_at,
  j.data->>'base_sha' as base_sha,
  j.data->>'head_sha' as head_sha
FROM jobs j
WHERE j.type = 'fetch_diff'::job_type
AND j.status = 'failed'
AND j.error_message LIKE '%No common ancestor%'
ORDER BY j.created_at DESC
LIMIT 10;
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ï¿½ï¿½ Results to look for:
  â€¢ How many failing fetch_diff jobs?
  â€¢ When did they start failing?
  â€¢ Are they all the same SHAs?
  â€¢ What project do they belong to?

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 3: DETERMINE ROOT CAUSE (3 minutes)

Check which scenario matches your data:

SCENARIO A: Webhook Parsing Bug (Most Likely - 60%)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Signs:
  â€¢ webhook_processing jobs completed successfully
  â€¢ But stored bad data
  â€¢ SHAs are truncated or malformed

Check:
  SELECT * FROM jobs 
  WHERE type = 'webhook_processing'::job_type
  AND created_at > NOW() - INTERVAL '1 day'
  AND status = 'completed';

  Then check: src/lib/github/webhook-parser.ts
  Looking for: SHA extraction, validation logic

Fix: Update webhook parser to validate SHAs


SCENARIO B: GitHub API Issue (20% probability)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Signs:
  â€¢ API rate limiting errors
  â€¢ Incomplete webhook responses
  â€¢ Data corruption in transit

Check:
  SELECT error_message FROM jobs 
  WHERE error_message LIKE '%rate limit%'
  OR error_message LIKE '%timeout%'
  AND created_at > NOW() - INTERVAL '1 day';

Fix: Implement exponential backoff + better error handling


SCENARIO C: Wrong Repository (10% probability)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Signs:
  â€¢ SHAs valid but in different repository
  â€¢ Webhook sent to wrong project
  â€¢ Mismatch between webhook repo and project

Check:
  SELECT j.data->>'repository', p.repo_name
  FROM jobs j
  LEFT JOIN projects p ON j.project_id = p.id
  WHERE j.type = 'webhook_processing'::job_type
  AND j.data->>'repository' != p.repo_name;

Fix: Reconfigure GitHub webhook delivery


SCENARIO D: Database Migration Bug (10% probability)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Signs:
  â€¢ All bad SHAs from same time period
  â€¢ Data has consistent pattern
  â€¢ Timestamp matches deployment/migration

Check:
  SELECT DATE(created_at), COUNT(*) 
  FROM commits 
  GROUP BY DATE(created_at);

Fix: Restore from backup or manual data correction

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 4: VERIFY SHAs AGAINST GITHUB (5 minutes)

Confirm that SHAs don't exist:

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
curl -s \
  -H "Authorization: token YOUR_GITHUB_TOKEN" \
  https://api.github.com/repos/OWNER/REPO/commits/c5c9ea85c587a25046f815cda8434e8fa00b536f \
  | jq '.message'
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Expected result: "Not Found" (HTTP 404)

If HTTP 200: SHA exists, so database might have it under wrong form
If 404: SHA definitely doesn't exist â†’ delete from database

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 5: FIX THE DATA (2-5 minutes)

Choose ONE based on your root cause:


OPTION A: Delete Invalid Records (If data is bad)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âš ï¸  DESTRUCTIVE! Only if:
    â€¢ Commits haven't been published
    â€¢ No summaries generated yet
    â€¢ You've confirmed SHAs don't exist in GitHub

DELETE FROM commits
WHERE sha IN (
  'c5c9ea85c587a25046f815cda8434e8fa00b536f',
  '401951fd91a3e8d32dcaa63333133411c4dd7978'
)
AND summary IS NULL;

DELETE FROM jobs
WHERE type = 'fetch_diff'::job_type
AND error_message LIKE '%No common ancestor%';


OPTION B: Correct the SHAs (If you know correct values)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

UPDATE commits
SET sha = 'CORRECT_SHA_HERE'
WHERE sha = 'c5c9ea85c587a25046f815cda8434e8fa00b536f'
AND summary IS NULL;

-- Then retry the failed jobs
UPDATE jobs
SET status = 'pending', attempts = 0, error_message = NULL
WHERE type = 'fetch_diff'::job_type
AND error_message LIKE '%No common ancestor%';


OPTION C: Fix the Source Code (Prevent future issues)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. Edit: src/lib/github/webhook-parser.ts

2. Add validation:

   function validateCommitSha(sha: string): boolean {
     return /^[a-f0-9]{7,40}$/.test(sha);
   }

3. Use before storing:

   if (!validateCommitSha(commit.sha)) {
     throw new Error('Invalid SHA: ' + commit.sha);
   }

4. Test the parser with sample webhook payloads

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

VERIFICATION: Did the Fix Work?

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-- 1. Check invalid SHAs are gone
SELECT COUNT(*) FROM commits 
WHERE sha ~ '[^a-f0-9]' OR LENGTH(sha) NOT IN (7, 40);
-- Expected: 0

-- 2. Check failed jobs are resolved
SELECT COUNT(*) FROM jobs 
WHERE type = 'fetch_diff'::job_type
AND status = 'failed'
AND error_message LIKE '%No common ancestor%';
-- Expected: 0 or decreasing

-- 3. Monitor for NEW invalid data
SELECT * FROM commits
WHERE created_at > NOW() - INTERVAL '1 hour'
AND (sha ~ '[^a-f0-9]' OR LENGTH(sha) NOT IN (7, 40));
-- Expected: EMPTY (no new bad data)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PREVENTION: Stop This From Happening Again

Add these to your codebase:

1ï¸âƒ£  SHA Validation Before Insert
    â”œâ”€ Validate format: /^[a-f0-9]{7,40}$/
    â”œâ”€ Check not null/empty
    â””â”€ Log validation failures

2ï¸âƒ£  Webhook Payload Logging
    â”œâ”€ Log raw webhook payload (first time only)
    â”œâ”€ Log parsed commit data
    â””â”€ Log any parsing errors

3ï¸âƒ£  GitHub API Validation
    â”œâ”€ Confirm SHA exists before using
    â”œâ”€ Handle 404 responses gracefully
    â””â”€ Add retry logic

4ï¸âƒ£  Database Integrity Checks
    â”œâ”€ Periodic validation query
    â”œâ”€ Alert if invalid SHAs found
    â””â”€ Auto-cleanup or manual review

5ï¸âƒ£  Unit Tests for Webhook Parser
    â”œâ”€ Test with valid payloads
    â”œâ”€ Test with malformed payloads
    â”œâ”€ Test with truncated SHAs
    â””â”€ Test with missing fields

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DETAILED GUIDE

For more information, see: DATA_INTEGRITY_INVESTIGATION.md

Contains:
  â€¢ 7-step detailed SQL investigation
  â€¢ 4 root cause scenarios with evidence
  â€¢ 4 remediation strategies
  â€¢ Prevention checklist
  â€¢ Testing procedures

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SUMMARY

1. Find invalid SHAs â†’ Use Step 1 SQL query
2. Find source       â†’ Use Step 2 SQL query
3. Determine cause   â†’ Check scenarios A-D
4. Verify with GitHub â†’ Use curl command
5. Fix the data      â†’ Pick Option A/B/C
6. Verify fix        â†’ Run verification queries
7. Prevent future    â†’ Add validation code

Expected time: 20-30 minutes total

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
